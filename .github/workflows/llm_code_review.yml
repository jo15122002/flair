name: LLM Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code_review:
    runs-on: ubuntu-latest

    steps:
      # Étape 1 : Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Étape 2 : Configuration de Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      # Étape 3 : Installation des dépendances
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Étape 4 : Lancer les tests unitaires
      - name: Run tests
        run: |
          pytest

      - name: Check environment variables
        run: |
            echo "GITHUB_TOKEN is set: $([ -z "${GITHUB_TOKEN}" ] && echo 'false' || echo 'true')"
            echo "LLM_ENDPOINT is set: $([ -z "${LLM_ENDPOINT}" ] && echo 'false' || echo 'true')"
        

      # Étape 5 : Exécuter le script principal pour la revue de code
      - name: Run LLM code review
        env:
          # Ces variables sont définies par GitHub Actions et/ou vos secrets
          REPOSITORY_GITHUB: ${{ github.repository }}
          PR_NUMBER_GITHUB: ${{ github.event.pull_request.number }}
          TOKEN_GITHUB: ${{ secrets.GITHUB_TOKEN }}
          # Vous pouvez également définir ici d'autres variables nécessaires (par exemple, LLM_ENDPOINT, DIFF_CHUNK_SIZE, etc.)
          LLM_ENDPOINT: ${{ secrets.LLM_ENDPOINT }}
          DIFF_CHUNK_SIZE: 10000
          CI_PLATFORM: github
        run: |
          python src/main.py
